<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DISE — Provisioning Service</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --accent:#ff4b5c;
    --bg:#ffffff;
    --fg:#0b0b0b;
    --muted:#6b6b6b;
    --radius:10px;
    --shadow: 0 8px 28px rgba(10,10,10,0.06);
    --maxw:920px;
    --gap:14px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;}
  .wrap{max-width:var(--maxw);margin:46px auto;padding:28px;border-radius:12px;box-shadow:var(--shadow);}
  h1{margin:0 0 6px;font-size:20px;}
  p.lead{margin:0 0 14px;color:var(--muted);}
  .card{background:#fff;border-radius:12px;padding:18px;margin-bottom:16px;border:1px solid rgba(0,0,0,0.04);}
  label.select{display:block;margin-bottom:8px;font-weight:600;font-size:13px}
  .row{display:flex;gap:var(--gap);align-items:center;}
  .radio{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  input[type="text"], input[type="email"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e8e8e8;font-size:14px;}
  button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;transition:transform .12s ease,box-shadow .12s;}
  button.secondary{background:#111;color:#fff;opacity:.95}
  button.ghost{background:transparent;color:var(--muted);border:1px solid rgba(0,0,0,0.06)}
  button:active{transform:translateY(1px)}
  .muted{color:var(--muted);font-size:13px}
  pre{background:#fafafa;padding:12px;border-radius:8px;overflow:auto;font-size:13px}
  .small{font-size:13px;color:var(--muted)}
  .success{border-left:4px solid #2ecc71;padding-left:12px}
  .danger{border-left:4px solid #ff4b5c;padding-left:12px}
  .actions{display:flex;gap:10px;margin-top:12px;align-items:center}
  footer{margin-top:18px;font-size:13px;color:var(--muted)}
  .loading{display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,0.25);border-top-color:rgba(255,255,255,0.95);animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .note{padding:10px;border-radius:10px;background:#fff7f7;border:1px solid rgba(255,75,92,0.08);color:#6b2d2d}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .logbox{max-height:220px;overflow:auto;background:#f7f9fb;padding:10px;border-radius:8px;border:1px solid #eef3f7;font-size:13px}
  .errorMsg{color:var(--muted);background:#fff5f5;padding:10px;border-radius:8px;border:1px solid rgba(255,75,92,0.08)}
  @media (max-width:720px){.row{flex-direction:column}}
</style>
</head>
<body>
  <div class="wrap card">
    <div class="flex-between" style="gap:12px;align-items:flex-start">
      <div>
      <h1>DISE — Provisioning Service</h1>
      
      <p class="lead">This tool will automatic get your Google workspace <strong>Customer ID</strong> and a Service Account JSON key for SignageOS provisioning. <br>
        <b>Select one of the options and you will be prompted to authorize this generation by using your admin Google account</b>
      </div>
      <div style="text-align:right">
        <div class="small">Temporarily host for development: <strong id="origin"></strong></div>
        <div class="small" style="margin-top:6px">Support: <strong>support@dise.com</strong></div>
      </div>
    </div>
 <h2>Google ChromeOS Provisioning for SignageOS</h2>
    <div class="card" id="controlsCard">
      <label class="select">Choose flow</label>
      <div class="radio">
        <input type="radio" id="variantA" name="variant" value="A" checked>
        <label for="variantA">Option A — Creates a new service account & key (recommended)</label>
      </div>
      <div class="radio">
        <input type="radio" id="variantB" name="variant" value="B">
        <label for="variantB">Option B — Use existing service account (enter its email)</label>
      </div>

      <div id="existingSA" style="display:none;margin-top:12px">
        <label class="select">Existing service account email</label>
        <input id="saEmail" placeholder="service-account@PROJECT.iam.gserviceaccount.com" />
        <div class="small">Enter the full service account email (project scoping determines permissions).</div>
      </div>

      <div style="margin-top:12px">
        <label class="select">Support email (recipient)</label>
        <input id="supportEmail" type="email" value="support@dise.com" />
        <div class="small">This will be prefilled when opening your mail client (mailto).</div>
      </div>

      <div style="margin-top:12px">
        <label class="select">Google OAuth Client ID</label>
        <input id="clientId" placeholder="Paste your OAuth Client ID here (created in Google Cloud Console)" />
        <div class="small">Web application client ID. Authorized JS origin must include this page origin.</div>
      </div>

      <div style="margin-top:12px">
        <label class="select">Optional: suggested service account project ID</label>
        <input id="projectId" placeholder="Project ID (for Variant A) — you will be prompted too" />
        <div class="small">If left blank, you will be prompted during the flow for the project to use.</div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button id="startBtn">Authenticate & Run</button>
        <button id="clearBtn" class="secondary">Clear output</button>
        <button id="downloadLogBtn" class="ghost">Download Audit Log</button>
      </div>

      <div id="status" style="margin-top:12px"></div>
    </div>

    <div id="resultCard" class="card" style="display:none">
      <div id="resultBox"></div>
      <div style="margin-top:12px" class="actions">
        <button id="mailBtn">Open mail client to send results</button>
        <button id="downloadBtn" class="secondary">Download JSON key</button>
      </div>
      <div class="small" style="margin-top:12px">Note: the mail button opens your local mail client with the Customer ID and JSON key in the body. You can edit before sending. For automated server uploads, replace this with a secure POST later.</div>
    </div>

    <div class="card" id="auditCard">
      <div class="flex-between">
        <div><strong>Audit log</strong> <span class="small">— keeps a local trace of actions & errors for troubleshooting</span></div>
        <div class="small">Logs stored in-memory & localStorage (cleared by Clear output)</div>
      </div>
      <div class="logbox" id="logBox" aria-live="polite"></div>
      <div style="margin-top:8px" class="small">If you contact support, attach the audit log file. It helps identify permission or org-policy failures.</div>
    </div>

    <footer>Minimal UI — v1 (dev). Handle generated keys carefully. For production, switch from mailto to secure backend upload.</footer>
  </div>

<script>
/* DISE enhanced provisioning client
   - Input validation
   - Better API error parsing (common Google IAM/Admin error signatures)
   - Audit logging with download
   - Soft UX improvements
*/

const originDisplay = document.getElementById('origin');
originDisplay.textContent = location.origin + location.pathname.replace(/\/[^\/]*$/, '/');

const variantEls = document.getElementsByName('variant');
const existingSAdiv = document.getElementById('existingSA');
const saEmailInput = document.getElementById('saEmail');
const clientIdInput = document.getElementById('clientId');
const supportEmailInput = document.getElementById('supportEmail');
const projectIdInput = document.getElementById('projectId');

for (const r of variantEls) {
  r.addEventListener('change', ()=> {
    existingSAdiv.style.display = (document.getElementById('variantB').checked ? 'block' : 'none');
  });
}

// default client id placeholder
const DEFAULT_CLIENT_ID = 'YOUR_OAUTH_CLIENT_ID_HERE';
clientIdInput.value = DEFAULT_CLIENT_ID;

let tokenClient = null;
let gapiLoaded = false;
let accessToken = null;
let lastKeyJson = null;
let lastCustomerId = null;
let lastSaEmail = null;
let lastFilename = null;

const SCOPES = [
  'https://www.googleapis.com/auth/admin.directory.customer.readonly',
  'https://www.googleapis.com/auth/iam'
];

const logEntries = [];

// ---------- Logging ----------
function log(level, msg, meta){
  const now = new Date().toISOString();
  const entry = {ts: now, level, msg, meta};
  logEntries.push(entry);
  // persist small trace to localStorage for partner convenience
  try { localStorage.setItem('dise_audit_log', JSON.stringify(logEntries.slice(-200))); } catch(e){}
  renderLog();
}
function renderLog(){
  const box = document.getElementById('logBox');
  box.innerHTML = logEntries.map(e => `<div><strong>[${e.ts}]</strong> <em>${e.level}</em> — ${escapeHtml(e.msg)}${e.meta?` <span class="small"> ${escapeHtml(JSON.stringify(e.meta))}</span>`:''}</div>`).join('');
}
function downloadLog(){
  const blob = new Blob([JSON.stringify(logEntries, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'dise-provisioning-audit-log.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// ---------- Status / UI helpers ----------
function setStatus(html, isError=false){
  const s = document.getElementById('status');
  s.innerHTML = html;
  s.className = isError ? 'danger' : '';
  if(isError) log('ERROR', html);
  else log('INFO', html);
}
function showResultBox(html){ document.getElementById('resultCard').style.display = 'block'; document.getElementById('resultBox').innerHTML = html; }
function clearResults(){ document.getElementById('resultCard').style.display = 'none'; document.getElementById('resultBox').innerHTML = ''; setStatus(''); lastKeyJson = null; lastCustomerId = null; lastSaEmail = null; lastFilename = null; log('INFO', 'Cleared results'); localStorage.removeItem('dise_audit_log'); }

// ---------- input validation ----------
function isValidClientId(id){
  // quick check: client ids look like <numbers>-...apps.googleusercontent.com
  return typeof id === 'string' && /\d+-[a-z0-9]+\.apps\.googleusercontent\.com$/.test(id.trim());
}
function isEmail(s){
  return typeof s === 'string' && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.trim());
}
function isProjectId(s){
  return typeof s === 'string' && /^[a-z][a-z0-9-]{5,29}$/.test(s.trim());
}
function isServiceAccountEmail(s){
  // e.g. name@project.iam.gserviceaccount.com
  return typeof s === 'string' && /^[^@\s]+@[^@\s]+\.iam\.gserviceaccount\.com$/.test(s.trim());
}

document.getElementById('downloadLogBtn').addEventListener('click', downloadLog);
document.getElementById('clearBtn').addEventListener('click', clearResults);

// ---------- Load gapi & GIS ----------
async function loadGapiClient(){
  if(gapiLoaded) return;
  await new Promise((res,rej)=>{
    const s = document.createElement('script');
    s.src = 'https://apis.google.com/js/api.js';
    s.onload = res;
    s.onerror = rej;
    document.head.appendChild(s);
  });
  await new Promise((res)=> gapi.load('client', res));
  gapiLoaded = true;
  log('INFO', 'gapi loaded');
}
async function initTokenClient(clientId){
  if(!window.google || !google.accounts || !google.accounts.oauth2){
    await new Promise((res,rej)=>{
      const s = document.createElement('script');
      s.src = 'https://accounts.google.com/gsi/client';
      s.onload = res;
      s.onerror = rej;
      document.head.appendChild(s);
    });
  }
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: clientId,
    scope: SCOPES.join(' '),
    callback: (tokenResponse) => {
      accessToken = tokenResponse && tokenResponse.access_token;
      if(accessToken && gapi && gapi.client) gapi.client.setToken({access_token: accessToken});
      setStatus('Authenticated ✓');
      log('INFO', 'Token client callback received', {scopes: SCOPES.join(' ')});
    }
  });
  log('INFO', 'Token client initialized');
}
async function requestAccessToken(){
  return new Promise((resolve,reject)=>{
    if(!tokenClient) return reject(new Error('token client not initialized'));
    setStatus('<span class="loading"></span> Opening Google sign-in...');
    tokenClient.requestAccessToken({prompt: 'consent'});
    const t0 = Date.now();
    const int = setInterval(()=>{
      if(accessToken){
        clearInterval(int);
        resolve(accessToken);
      } else if(Date.now() - t0 > 60000){
        clearInterval(int);
        reject(new Error('Timeout waiting for token (60s)'));
      }
    },300);
  });
}

// ---------- API calls ----------
async function callAdminGetCustomer(){
  try {
    const res = await gapi.client.request({
      path: 'https://admin.googleapis.com/admin/directory/v1/customers/my_customer',
      method: 'GET',
    });
    log('INFO', 'Admin SDK customer.get response', {status:res.status});
    return res.result;
  } catch(e){
    throw e;
  }
}
async function createServiceAccount(projectId, accountId, displayName){
  const parent = `projects/${projectId}`;
  const body = {accountId, serviceAccount:{displayName}};
  try {
    const res = await gapi.client.request({
      path: `https://iam.googleapis.com/v1/${parent}/serviceAccounts`,
      method: 'POST',
      body: body
    });
    log('INFO', 'Service account created', {email: res.result.email});
    return res.result;
  } catch(e){
    throw e;
  }
}
async function createServiceAccountKey(saEmail){
  const name = `projects/-/serviceAccounts/${encodeURIComponent(saEmail)}`;
  const body = {privateKeyType: 'TYPE_GOOGLE_CREDENTIALS_FILE'};
  try {
    const res = await gapi.client.request({
      path: `https://iam.googleapis.com/v1/${name}/keys`,
      method: 'POST',
      body: body
    });
    log('INFO', 'Service account key created');
    return res.result;
  } catch(e){
    throw e;
  }
}

// ---------- Error parsing helpers ----------
function extractErrorMessage(err){
  // gapi client errors often have either err.result.error.message or err.message
  try {
    if(!err) return 'Unknown error';
    // If it's a plain Error with message
    if(err.message && !err.result) return err.message;
    // If gapi error object
    if(err.result && err.result.error){
      const e = err.result.error;
      // prefer detailed messages if present
      if(e.message) return e.message + (e.status ? ` (${e.status})` : '');
      if(e.errors && e.errors.length) return e.errors.map(x => x.message || JSON.stringify(x)).join('; ');
    }
    // Some server responses include error_description
    if(err.error_description) return err.error_description;
    if(err.error) return JSON.stringify(err.error);
    // fallback to JSON stringify
    return JSON.stringify(err).slice(0,1000);
  } catch(e){
    return 'Error parsing error message';
  }
}
function suggestRemedy(err){
  // Common patterns to watch for
  const txt = (extractErrorMessage(err) || '').toLowerCase();
  if(txt.includes('request had insufficient authentication scopes')) return 'Missing OAuth scopes. Ensure the OAuth client requests the Admin SDK and IAM scopes.';
  if(txt.includes('not found') && txt.includes('customers')) return 'Admin SDK may not be enabled, or your account is not a Workspace admin. Ensure Admin SDK API is enabled and you log in as a Workspace Super Admin.';
  if(txt.includes('permission denied') || txt.includes('insufficient permissions')) return 'Your Google account lacks required IAM roles. For Variant A you need Service Account Admin / IAM Admin for the target project. For Admin SDK, you need Workspace Super Admin.';
  if(txt.includes('policy') && txt.includes('denies') || txt.includes('org policy') || txt.includes('constraint')) return 'Organization policy may block creation of service account keys. Speak with the partner\'s Cloud Admin to allow key creation or use a pre-existing key.';
  if(txt.includes('quota') || txt.includes('rate')) return 'Google API quota exceeded or rate limited. Retry after a short delay.';
  if(txt.includes('cors') || txt.includes('access-control')) return 'CORS issue: ensure page is served over HTTPS and origin is authorized in OAuth client.';
  return 'See the extracted error message. Common fixes: (1) ensure APIs are enabled; (2) ensure you are using a Workspace Super Admin; (3) ensure project IAM roles permit service account creation; (4) org policies may block keys.';
}

// ---------- Utilities ----------
function b64ToUtf8(b64){
  try { return decodeURIComponent(escape(atob(b64))); } catch(e){ return atob(b64); }
}
function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ---------- Main flow ----------
document.getElementById('startBtn').addEventListener('click', async ()=>{
  clearResults();
  const clientId = (clientIdInput.value || '').trim();
  const supportEmail = (supportEmailInput.value || '').trim();
  const variant = document.getElementById('variantB').checked ? 'B' : 'A';
  const existingSa = (saEmailInput.value || '').trim();
  const suggestedProject = (projectIdInput.value || '').trim();

  // Validate inputs
  if(!clientId) { setStatus('Please paste your OAuth Client ID in the field above.', true); return; }
  if(!isValidClientId(clientId)) { setStatus('OAuth Client ID format looks invalid. It should end with ".apps.googleusercontent.com".', true); log('WARN','Invalid client id format', {clientId}); return; }
  if(!isEmail(supportEmail)){ setStatus('Support email looks invalid. Please correct it.', true); log('WARN','Invalid support email', {supportEmail}); return; }
  if(variant === 'B' && !isServiceAccountEmail(existingSa)){ setStatus('Existing service account email looks invalid. Expected format: name@project.iam.gserviceaccount.com', true); log('WARN','Invalid SA email', {existingSa}); return; }

  try {
    setStatus('Loading Google libraries...');
    log('INFO', 'Starting provisioning flow', {variant, supportEmail});
    await loadGapiClient();
    await initTokenClient(clientId);
    setStatus('Requesting permissions — sign in in the popup and choose the Workspace admin account...');
    await requestAccessToken();
    // load discovery docs for used APIs
    await gapi.client.load('https://content.googleapis.com/discovery/v1/apis/admin/directory_v1/rest');
    await gapi.client.load('https://content.googleapis.com/discovery/v1/apis/iam/v1/rest');
    setStatus('Fetching Workspace Customer ID...');
    const cust = await callAdminGetCustomer();
    const customerId = cust && (cust.id || cust.customerId || cust['id']);
    if(!customerId) throw new Error('Customer ID not found in response');
    lastCustomerId = customerId;
    setStatus('Customer ID obtained: ' + customerId);
    log('INFO', 'Obtained customer id', {customerId});
    // Project selection
    let projectId = suggestedProject || null;
    if(variant === 'A'){
      if(!projectId){
        projectId = window.prompt('Enter the Google Cloud project ID in which to create the service account (example: my-project-id):');
      }
      if(!projectId || !isProjectId(projectId)){ throw new Error('Invalid or missing project ID. Project IDs are lowercase, 6-30 chars, start with a letter.'); }
    }
    let saEmail = existingSa || null;
    if(variant === 'A'){
      setStatus('Creating service account in project ' + projectId + ' ...');
      // create accountId
      const rand = Math.random().toString(36).slice(2,8);
      const accountId = `signageos-${rand}`;
      const displayName = 'SignageOS integration (created via DISE)';
      let sa = null;
      try {
        sa = await createServiceAccount(projectId, accountId, displayName);
      } catch(e){
        const em = extractErrorMessage(e);
        const remedy = suggestRemedy(e);
        setStatus('Failed to create service account: ' + em, true);
        showErrorDetail('Create service account failed', em, remedy);
        log('ERROR','Create service account error', {err: em});
        return;
      }
      saEmail = sa.email;
      lastSaEmail = saEmail;
      setStatus('Service account created: ' + saEmail + ' — creating key ...');
      log('INFO','Service account created', {saEmail});
    } else {
      setStatus('Using existing service account: ' + saEmail + ' — creating key ...');
      lastSaEmail = saEmail;
      log('INFO','Using existing SA', {saEmail});
    }

    // Create key
    let keyResp = null;
    try {
      keyResp = await createServiceAccountKey(saEmail);
    } catch(e){
      const em = extractErrorMessage(e);
      const remedy = suggestRemedy(e);
      setStatus('Failed to create service account key: ' + em, true);
      showErrorDetail('Create service account key failed', em, remedy);
      log('ERROR','Create SA key error', {err: em});
      return;
    }
    const keyDataB64 = keyResp.privateKeyData;
    const keyJson = b64ToUtf8(keyDataB64);
    lastKeyJson = keyJson;
    lastFilename = (saEmail || 'service-account').replace(/[@\/]/g,'_') + '-key.json';
    const pretty = `<div class="success"><strong>Customer ID:</strong> ${escapeHtml(customerId)}<br><strong>Service account:</strong> ${escapeHtml(saEmail)}</div>
      <h4 style="margin-top:12px">Private key (JSON)</h4>
      <pre id="keyPre">${escapeHtml(keyJson)}</pre>`;
    showResultBox(pretty);
    setStatus('Success — key generated. Please handle the JSON key carefully.');
    log('INFO','Key generated successfully', {saEmail, filename: lastFilename});
  } catch(err){
    const em = extractErrorMessage(err);
    const remedy = suggestRemedy(err);
    setStatus('Unexpected error: ' + em, true);
    showErrorDetail('Unexpected error', em, remedy);
    log('ERROR', 'Unexpected flow error', {err: em});
    console.error(err);
  }
});

// show friendly detailed error section
function showErrorDetail(title, message, remedy){
  const rc = document.getElementById('resultCard');
  rc.style.display = 'block';
  document.getElementById('resultBox').innerHTML = `<div class="danger"><strong>${escapeHtml(title)}</strong><div class="small" style="margin-top:6px">${escapeHtml(message)}</div></div>
    <div style="margin-top:8px" class="note"><strong>Suggested fix:</strong> ${escapeHtml(remedy)}</div>`;
}

// download key & mail handlers
document.getElementById('downloadBtn').addEventListener('click', ()=>{
  if(!lastKeyJson) return alert('No key available');
  const blob = new Blob([lastKeyJson], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = lastFilename || 'service-account-key.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  log('INFO','Key downloaded', {filename:lastFilename});
});

document.getElementById('mailBtn').addEventListener('click', ()=>{
  const to = encodeURIComponent((supportEmailInput.value||'support@dise.com').trim());
  const subject = encodeURIComponent('SignageOS provisioning - Customer ID & Service Account Key');
  let body = `Hello%0A%0APlease find the Customer ID and service account key below.%0A%0ACustomer ID: ${encodeURIComponent(lastCustomerId || '(missing)')}%0AService account: ${encodeURIComponent(lastSaEmail || '(missing)')}%0A%0APrivate key (JSON):%0A%0A`;
  if(lastKeyJson){
    body += encodeURIComponent(lastKeyJson) + '%0A%0A';
  } else {
    body += encodeURIComponent('(no key data)') + '%0A%0A';
  }
  body += encodeURIComponent('Sent from DISE provisioning tool.');
  const mailto = `mailto:${to}?subject=${subject}&body=${body}`;
  // open mail client
  window.location.href = mailto;
  log('INFO','Opened mail client', {to});
});

// init log from storage if any
try {
  const saved = JSON.parse(localStorage.getItem('dise_audit_log') || '[]');
  if(Array.isArray(saved) && saved.length) {
    saved.forEach(s => logEntries.push(s));
    renderLog();
  } else {
    log('INFO','No previous logs found (fresh start)');
  }
} catch(e){ log('WARN','Failed to read saved logs', {err:e.message}); renderLog(); }

</script>
</body>
</html>
