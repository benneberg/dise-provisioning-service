<!doctype html>
<html lang="en" class="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DISE — Provisioning</title>
<link rel="icon" href="data:,">
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<style>
  /* Base styles */
  body {
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  /* Glassmorphism base for modals */
  .glass-modal-content {
    @apply bg-gray-800/70 backdrop-blur-md border border-gray-700/50 rounded-lg shadow-2xl;
  }

  /* Animations */
  .fade-in { animation: fadeIn 0.3s ease-out; }
  .fade-out { animation: fadeOut 0.3s ease-in forwards; }
  .scale-in { animation: scaleIn 0.3s ease-out; }
  .scale-out { animation: scaleOut 0.3s ease-in forwards; }
  .slide-in-bottom { animation: slideInBottom 0.3s ease-out; }
  .slide-out-bottom { animation: slideOutBottom 0.3s ease-in forwards; }

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
  @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  @keyframes scaleOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
  @keyframes slideInBottom { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideOutBottom { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }

  /* Custom loader for buttons */
  .btn-loader {
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 50%;
    display: inline-block;
    border-top: 2px solid #fff;
    border-right: 2px solid transparent;
    box-sizing: border-box;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
<script>
  // Apply Tailwind dark mode
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: {
          // New green accent color
          accent: {
            light: '#34d399', // green-400
            DEFAULT: '#10b981', // green-500
            dark: '#059669',  // green-600
          }
        }
      }
    }
  }
</script>
</head>

<body class="bg-gray-900 text-gray-200">

  <div class="wrap min-h-screen w-full p-4 sm:p-8 flex flex-col items-center">

    <header class="flex w-full max-w-4xl items-center gap-4 py-4">
      <div class="text-5xl font-bold tracking-tighter text-white">
        dise
      </div>
      <div class="border-l border-gray-700 pl-4">
        <h1 class="text-lg font-semibold text-white">Provisioning</h1>
        <p class="text-sm text-gray-400">Partner first. Partner only.</p>
      </div>
    </header>

    <div class="card w-full max-w-4xl bg-gray-800/70 backdrop-blur-md border border-gray-700/50 rounded-xl shadow-2xl overflow-hidden mt-4">
      
      <div class="tabs flex gap-2 p-3 border-b border-gray-700/50" role="tablist" aria-label="Main tabs">
        <button class="tab active flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all" data-tab="provision" role="tab" aria-selected="true">
          Provision
        </button>
        <button class="tab flex-1 py-2 px-4 rounded-md text-sm font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-all" data-tab="readme" role="tab" aria-selected="false">
          Readme
        </button>
      </div>
      <style>
        .tab.active {
          @apply bg-accent shadow-md text-white;
        }
      </style>

      <div class="tab-panels p-4 sm:p-6 min-h-[400px]">
        
        <div class="tab-panel" id="panel-provision">
          
          <div class="mb-6">
            <label for="clientId" class="block text-sm font-medium text-gray-300 mb-2">Development only. Not exposed in production. OAuth Client ID</label>
            <input id="clientId" type="text" placeholder="xxxxxxxxxx-xxxx.apps.googleusercontent.com" 
                   class="block w-full px-4 py-2 bg-gray-900/50 border border-gray-600 rounded-md shadow-sm text-gray-200 focus:ring-accent focus:border-accent transition"
                   value="YOUR_OAUTH_CLIENT_ID_HERE" />
          </div>

          <label class="block text-sm font-medium text-gray-300 mb-2">Choose Provisioning Option</label>
          <div class="optionGrid grid grid-cols-1 md:grid-cols-3 gap-4">
            
            <div class="opt flex flex-col justify-between bg-gray-700/50 p-5 rounded-lg border border-transparent hover:border-gray-600/50 hover:bg-gray-700/80 transition-all">
              <div>
                <div class="flex justify-between items-center">
                  <h3 class="font-semibold text-white">Option A — Create with new GoogleService account</h3>
                  <button class="infoBtn text-gray-400 hover:text-white" aria-label="More info for Option A" data-modal-target="modalA">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                  </button>
                </div>
              </div>
              <button class="btn runBtn w-full mt-4 bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-md transition-all duration-200 ease-in-out flex items-center justify-center gap-2" data-action="runA">
                <span class="btn-text">Run</span>
              </button>
            </div>

            <div class="opt flex flex-col justify-between bg-gray-700/50 p-5 rounded-lg border border-transparent hover:border-gray-600/50 hover:bg-gray-700/80 transition-all">
              <div>
                <div class="flex justify-between items-center mb-3">
                  <h3 class="font-semibold text-white">Option B — Use existing SA</h3>
                  <button class="infoBtn text-gray-400 hover:text-white" aria-label="More info for Option B" data-modal-target="modalB">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                  </button>
                </div>
                <input id="saEmailInput" type="email" placeholder="name@project.iam.gserviceaccount.com" 
                       class="block w-full text-sm px-3 py-2 bg-gray-900/50 border border-gray-600 rounded-md shadow-sm text-gray-200 focus:ring-accent focus:border-accent transition" />
              </div>
              <button class="btn runBtn w-full mt-4 bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-md transition-all duration-200 ease-in-out flex items-center justify-center gap-2" data-action="runB">
                <span class="btn-text">Run</span>
              </button>
            </div>

            <div class="opt flex flex-col justify-between bg-gray-700/50 p-5 rounded-lg border border-transparent hover:border-gray-600/50 hover:bg-gray-700/80 transition-all">
              <div>
                <div class="flex justify-between items-center">
                  <h3 class="font-semibold text-white">Option C — Self-run Script</h3>
                  <button class="infoBtn text-gray-400 hover:text-white" aria-label="More info for Option C" data-modal-target="modalC">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                  </button>
                </div>
              </div>
              <button class="btn w-full mt-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md transition-all duration-200 ease-in-out" id="viewScriptBtn">
                View Script
              </button>
            </div>
          </div>
          
          <div class="card bg-gray-900/80 rounded-lg mt-4 hidden" id="scriptCard">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
              <div>
                <strong class="text-white">Onboarding Script (gcloud)</strong>
                <div class="text-sm text-gray-400 mt-1">Run this script in your Google Cloud Shell or local CLI.</div>
              </div>
              <div class="flex gap-2">
                <button class="copyBtn p-2 rounded-md bg-gray-700 hover:bg-gray-600 text-gray-300" id="copyScriptBtn" aria-label="Copy script">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                </button>
                <button class="ghost p-2 rounded-md bg-gray-700 hover:bg-gray-600 text-gray-300" id="closeScript" aria-label="Close script">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
              </div>
            </div>
            <pre class="code p-4 overflow-auto"><code id="scriptCode" class="text-sm text-gray-300 font-mono" style="white-space:pre-wrap;"></code></pre>
          </div>

          <div class="bg-gray-800/50 rounded-lg mt-6">
            <div class="statusLine p-4 border-b border-gray-700" id="statusLine">
              <div class="text-sm text-gray-400">Ready</div>
            </div>
            <div id="resultArea" style="display:none" class="resultBox p-4"></div>
            <div class="flex justify-end gap-2 p-3 bg-gray-800/30 rounded-b-lg">
              <button class="ghost text-xs py-2 px-3 rounded-md bg-gray-700 hover:bg-gray-600 text-gray-300" id="downloadLogBtn">Download log</button>
              <button class="secondary text-xs py-2 px-3 rounded-md bg-gray-700 hover:bg-gray-600 text-gray-300" id="clearBtn">Clear</button>
            </div>
          </div>
        </div>

        <div class="tab-panel hidden" id="panel-readme">
          <div class="prose prose-invert prose-sm max-w-none text-gray-300">
            <h3 class="text-white">About this tool</h3>
            <p>A compact provisioning assistant for partners. Use a Workspace Super Admin account to create service accounts and keys for SignageOS.</p>
            <ul>
              <li><strong>Option A:</strong> Creates a new Service Account + JSON key (recommended).</li>
              <li><strong>Option B:</strong> Uses an existing Service Account (you must provide the full email).</li>
              <li><strong>Option C:</strong> A self-run `gcloud` script for use in your own Google Cloud environment if you cannot use hosted OAuth flows.</li>
            </ul>
            <p>If an operation fails, copy the one-line error code and email <strong>support@dise.com</strong>. We include a short audit excerpt in your message to help support triage faster.</p>
          </div>
        </div>
      </div>
    </div>
    
    <footer class="mt-8 py-4 text-center text-gray-500 text-sm">
      Partner support: <a href="mailto:support@dise.com" class="text-gray-400 hover:text-accent transition">support@dise.com</a>
    </footer>

  </div>

  <div class="toastWrap fixed left-1/2 -translate-x-1/2 bottom-6 z-[9999] flex flex-col gap-2 items-center" id="toasts" aria-live="polite"></div>

  <div id="modalA" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 hidden fade-in" aria-hidden="true">
    <div class="modal-content glass-modal-content w-full max-w-md p-6 rounded-lg shadow-xl scale-in">
      <h3 class="text-lg font-medium text-white mb-2">Option A: Create new Service Account</h3>
      <p class="text-sm text-gray-300 mb-4">Automatically creates a service account & key in your chosen project.</p>
      <strong class="text-sm text-gray-200">Requires:</strong>
      <p class="text-sm text-gray-300 mb-4">Workspace Super Admin + IAM permissions in the target project.</p>
      <strong class="text-sm text-gray-200">Details:</strong>
      <p class="text-sm text-gray-300">Creates a new SA inside the selected project, then generates a JSON key file for download. If org policy prevents key creation, use the script or Option B.</p>
      <button class="modal-close-btn w-full mt-6 bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-md transition-all">Close</button>
    </div>
  </div>

  <div id="modalB" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 hidden fade-in" aria-hidden="true">
    <div class="modal-content glass-modal-content w-full max-w-md p-6 rounded-lg shadow-xl scale-in">
      <h3 class="text-lg font-medium text-white mb-2">Option B: Use existing Service Account</h3>
      <p class="text-sm text-gray-300 mb-4">Provide the service account email; a key will be created for that account.</p>
      <strong class="text-sm text-gray-200">Why use this?</strong>
      <p class="text-sm text-gray-300 mb-4">Use when your organization forbids programmatic SA creation or you prefer to reuse an existing account.</p>
      <strong class="text-sm text-gray-200">Details:</strong>
      <p class="text-sm text-gray-300">Enter the full service account email (e.g. `name@project.iam.gserviceaccount.com`). The tool will create a key for it if allowed.</p>
      <button class="modal-close-btn w-full mt-6 bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-md transition-all">Close</button>
    </div>
  </div>
  
  <div id="modalC" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 hidden fade-in" aria-hidden="true">
    <div class="modal-content glass-modal-content w-full max-w-md p-6 rounded-lg shadow-xl scale-in">
      <h3 class="text-lg font-medium text-white mb-2">Option C: Self-run gcloud Script</h3>
      <p class="text-sm text-gray-300 mb-4">Copy & run in your environment. No keys leave your project.</p>
      <strong class="text-sm text-gray-200">Why use this?</strong>
      <p class="text-sm text-gray-300 mb-4">Great for strict security policies. Produces the same result but runs inside your Google account's Cloud Shell or local `gcloud` CLI.</p>
      <strong class="text-sm text-gray-200">Details:</strong>
      <p class="text-sm text-gray-300">Click "View Script" to see a ready-to-copy shell script that partners can run themselves. The script uses `gcloud` commands and writes the key to your local disk.</p>
      <button class="modal-close-btn w-full mt-6 bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-md transition-all">Close</button>
    </div>
  </div>

<script>
/* -------------------------
   Utilities & logging
   ------------------------- */
const logEntries = [];
function log(level, msg, meta) {
  const e = { ts: new Date().toISOString(), level, msg, meta };
  logEntries.push(e);
  try { localStorage.setItem('dise_audit_log', JSON.stringify(logEntries.slice(-400))); } catch (e) {}
}
function getLogExcerpt(lines = 80) {
  const tail = logEntries.slice(-lines);
  return tail.map(x => `[${x.ts}] ${x.level} — ${x.msg} ${x.meta ? JSON.stringify(x.meta) : ''}`).join('\n');
}
function downloadLogFile() {
  const blob = new Blob([JSON.stringify(logEntries, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'dise-provisioning-audit-log.json'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* Toast system */
const toastContainer = document.getElementById('toasts');
function showToast(type, text, opts = {}) {
  const el = document.createElement('div');
  const typeClasses = {
    info: 'bg-gray-700 text-white',
    success: 'bg-accent text-white',
    error: 'bg-red-600 text-white'
  };
  el.className = `toast shadow-lg rounded-md py-3 px-5 flex gap-3 items-center slide-in-bottom ${typeClasses[type] || typeClasses.info}`;
  
  if (opts.loader) {
    el.innerHTML = `<span class="btn-loader !border-t-white !border-r-transparent w-5 h-5"></span> <span>${text}</span>`;
  } else {
    el.textContent = text;
  }
  
  toastContainer.appendChild(el);
  if (!opts.persistent) {
    setTimeout(() => {
      el.classList.remove('slide-in-bottom');
      el.classList.add('slide-out-bottom');
      setTimeout(() => el.remove(), 300);
    }, opts.duration || 3000);
  }
  return el;
}

/* Copy helper */
async function copyText(t) {
  try { await navigator.clipboard.writeText(t); showToast('success', 'Copied to clipboard'); } catch (e) { showToast('error', 'Copy failed'); }
}

/* -------------------------
   UI wiring
   ------------------------- */
document.addEventListener('DOMContentLoaded', () => {

  // Tabs
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.tab-panel');
  tabs.forEach(t => t.addEventListener('click', () => {
    tabs.forEach(x => {
      x.classList.remove('active');
      x.setAttribute('aria-selected', 'false');
      x.classList.add('text-gray-400', 'hover:bg-gray-700/50', 'hover:text-gray-200');
    });
    t.classList.add('active');
    t.classList.remove('text-gray-400', 'hover:bg-gray-700/50', 'hover:text-gray-200');
    t.setAttribute('aria-selected', 'true');

    panels.forEach(p => p.classList.add('hidden'));
    document.getElementById(`panel-${t.dataset.tab}`).classList.remove('hidden');
  }));

  // Modals
  document.querySelectorAll('.infoBtn').forEach(btn => {
    const modal = document.getElementById(btn.dataset.modalTarget);
    btn.addEventListener('click', () => {
      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
    });
  });
  document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal || e.target.closest('.modal-close-btn')) {
        modal.classList.add('hidden'); // Simplified: just hide
        modal.setAttribute('aria-hidden', 'true');
      }
    });
  });

  /* -------------------------
     Provisioning core
     ------------------------- */

  let gapiLoaded = false;
  let tokenClient = null;
  let accessToken = null;
  const SCOPES = [
    'https://www.googleapis.com/auth/admin.directory.customer.readonly',
    'https://www.googleapis.com/auth/iam'
  ];

  async function loadGapiLibs() {
    if (gapiLoaded) return;
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://apis.google.com/js/api.js';
      s.onload = res; s.onerror = rej; document.head.appendChild(s);
    });
    await new Promise((res) => gapi.load('client', res));
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://accounts.google.com/gsi/client';
      s.onload = res; s.onerror = rej; document.head.appendChild(s);
    });
    gapiLoaded = true;
    log('INFO', 'gapi and gsi loaded');
  }

  async function initTokenClient(clientId) {
    if (!window.google || !google.accounts || !google.accounts.oauth2) {
      throw new Error('GSI not available');
    }
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: SCOPES.join(' '),
      callback: (resp) => {
        accessToken = resp && resp.access_token;
        if (accessToken && gapi && gapi.client) gapi.client.setToken({ access_token: accessToken });
        log('INFO', 'token received');
      }
    });
    log('INFO', 'Token client initialized');
  }

  function extractErrorMessage(err) {
    try {
      if (!err) return 'Unknown error';
      if (err.message && !err.result) return err.message;
      if (err.result && err.result.error) {
        const e = err.result.error;
        if (e.message) return e.message;
        if (e.errors && e.errors.length) return e.errors.map(x => x.message || JSON.stringify(x)).join('; ');
      }
      if (err.error_description) return err.error_description;
      if (err.error) return JSON.stringify(err.error);
      return JSON.stringify(err).slice(0, 800);
    } catch (e) { return 'Error parsing error'; }
  }
  function genErrorCode() {
    const t = Date.now().toString(36).slice(-6).toUpperCase();
    return 'ERR_' + t;
  }

  /* API wrappers */
  async function adminGetCustomer() {
    const res = await gapi.client.request({ path: 'https://admin.googleapis.com/admin/directory/v1/customers/my_customer', method: 'GET' });
    return res.result;
  }
  async function createServiceAccount(projectId, accountId, displayName) {
    const parent = `projects/${projectId}`;
    const body = { accountId, serviceAccount: { displayName } };
    const res = await gapi.client.request({ path: `https://iam.googleapis.com/v1/${parent}/serviceAccounts`, method: 'POST', body });
    return res.result;
  }
  async function createServiceAccountKey(saEmail) {
    const name = `projects/-/serviceAccounts/${encodeURIComponent(saEmail)}`;
    const body = { privateKeyType: 'TYPE_GOOGLE_CREDENTIALS_FILE' };
    const res = await gapi.client.request({ path: `https://iam.googleapis.com/v1/${name}/keys`, method: 'POST', body });
    return res.result;
  }

  /* run flow helpers */
  const statusLine = document.getElementById('statusLine');
  const resultArea = document.getElementById('resultArea');

  function setStatus(html, isError = false) {
    statusLine.querySelector('div').textContent = html;
    if (isError) {
      statusLine.querySelector('div').classList.add('text-red-400');
      log('ERROR', html);
    } else {
      statusLine.querySelector('div').classList.remove('text-red-400');
      log('INFO', html);
    }
  }

  function setButtonLoading(btn, isLoading) {
    const text = btn.querySelector('.btn-text');
    if (isLoading) {
      btn.disabled = true;
      btn.classList.add('opacity-70', 'cursor-not-allowed');
      if (text) text.classList.add('hidden');
      // Add loader if not present
      if (!btn.querySelector('.btn-loader')) {
        const loader = document.createElement('span');
        loader.className = 'btn-loader';
        btn.prepend(loader);
      }
    } else {
      btn.disabled = false;
      btn.classList.remove('opacity-70', 'cursor-not-allowed');
      if (text) text.classList.remove('hidden');
      const loader = btn.querySelector('.btn-loader');
      if (loader) loader.remove();
    }
  }

  /* main runner A */
  async function runFlowA(opts, btn) {
    const clientId = opts.clientId;
    setButtonLoading(btn, true);
    try {
      setStatus('Loading Google libraries...');
      showToast('info', 'Opening sign-in...', { duration: 3000, loader: true });
      await loadGapiLibs();
      await initTokenClient(clientId);
      tokenClient.requestAccessToken({ prompt: 'consent' });
      setStatus('Awaiting consent...');
      await new Promise((resolve, reject) => {
        const t0 = Date.now();
        const it = setInterval(() => { if (accessToken) { clearInterval(it); resolve(); } else if (Date.now() - t0 > 60000) { clearInterval(it); reject(new Error('Timeout waiting for token')); } }, 200);
      });
      await gapi.client.load('https://content.googleapis.com/discovery/v1/apis/admin/directory_v1/rest');
      await gapi.client.load('https://content.googleapis.com/discovery/v1/apis/iam/v1/rest');
      setStatus('Fetching Workspace Customer ID...');
      const cust = await adminGetCustomer();
      const customerId = cust && (cust.id || cust.customerId || cust['id']);
      log('INFO', 'Customer ID fetched', { customerId });
      setStatus('Customer ID obtained: ' + (customerId || '(missing)'));
      
      let projectId = prompt('Enter the Google Cloud project ID where the service account should be created (e.g. my-project-id):');
      
      if (!projectId || !/^[a-z][a-z0-9-]{5,29}$/.test(projectId)) {
        throw new Error('Invalid or missing project ID');
      }
      setStatus('Creating service account in ' + projectId + ' ...');
      const rand = Math.random().toString(36).slice(2, 8);
      const accountId = `signageos-${rand}`;
      const sa = await createServiceAccount(projectId, accountId, 'SignageOS integration (created via DISE)');
      const saEmail = sa.email;
      setStatus('Service account created: ' + saEmail + ' — creating key...');
      log('INFO', 'Created service account', { saEmail });
      const keyResp = await createServiceAccountKey(saEmail);
      const keyDataB64 = keyResp.privateKeyData;
      const keyJson = atob(keyDataB64);
      
      // success UI
      resultArea.style.display = 'block';
      resultArea.innerHTML = `<div class="p-4 bg-green-900/50 border border-accent rounded-lg">
        <div class_="mb-3"><strong>Customer ID:</strong> <span class="font-mono text-accent-light bg-gray-900/50 px-2 py-1 rounded">${customerId || '(unknown)'}</span></div>
        <div class="mt-2 mb-4"><strong>Service account:</strong> <span class="font-mono text-accent-light bg-gray-900/50 px-2 py-1 rounded">${saEmail}</span></div>
        <button class="btn bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-md" id="downloadKeyBtn">Download JSON key</button>
      </div>`;
      
      document.getElementById('downloadKeyBtn').addEventListener('click', () => {
        const blob = new Blob([keyJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = (saEmail.replace(/[@\/]/g, '_') + '-key.json'); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showToast('success', 'Key downloaded');
        log('INFO', 'Key downloaded', { saEmail });
      });
      setStatus('Success — key generated. Handle it carefully.');
      showToast('success', 'Key generated');
      log('INFO', 'Flow A completed', { customerId, saEmail });
    } catch (err) {
      const em = extractErrorMessage(err);
      log('ERROR', 'Flow A failed', { err: em });
      const code = genErrorCode();
      const excerpt = getLogExcerpt(50);
      resultArea.style.display = 'block';
      resultArea.innerHTML = `<div class="oneLineError p-4 bg-red-900/50 border border-red-500 rounded-lg flex justify-between items-center gap-4">
        <div class="text-red-300">Provisioning failed — ${code}. Copy & email this to support.</div>
        <button class="ghost p-2 rounded-md bg-red-700/50 hover:bg-red-700 text-red-200" id="mailErr">Contact</button>
      </div>`;
      document.getElementById('mailErr').addEventListener('click', () => openSupportMail({ errorCode: code, excerpt }));
      setStatus('Provisioning failed — ' + code, true);
      showToast('error', 'Provisioning failed — ' + code, { persistent: true });
    } finally {
      setButtonLoading(btn, false);
    }
  }

  /* main runner B */
  async function runFlowB(opts, btn) {
    setButtonLoading(btn, true);
    try {
      setStatus('Loading Google libraries...');
      showToast('info', 'Opening sign-in...', { duration: 3000, loader: true });
      await loadGapiLibs();
      await initTokenClient(opts.clientId);
      tokenClient.requestAccessToken({ prompt: 'consent' });
      setStatus('Awaiting consent...');
      await new Promise((resolve, reject) => {
        const t0 = Date.now();
        const it = setInterval(() => { if (accessToken) { clearInterval(it); resolve(); } else if (Date.now() - t0 > 60000) { clearInterval(it); reject(new Error('Timeout waiting for token')); } }, 200);
      });
      await gapi.client.load('https://content.googleapis.com/discovery/v1/apis/iam/v1/rest');
      
      const saEmail = opts.saEmail;
      if (!saEmail || !/^[^@\s]+@[^@\s]+.iam.gserviceaccount.com$/.test(saEmail)) throw new Error('Invalid service account email');
      
      setStatus('Creating key for ' + saEmail + ' ...');
      const keyResp = await createServiceAccountKey(saEmail);
      const keyJson = atob(keyResp.privateKeyData);
      
      resultArea.style.display = 'block';
      resultArea.innerHTML = `<div class="p-4 bg-green-900/50 border border-accent rounded-lg">
        <div class="mb-4"><strong>Service account:</strong> <span class="font-mono text-accent-light bg-gray-900/50 px-2 py-1 rounded">${saEmail}</span></div>
        <button class="btn bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-md" id="downloadKeyBtnB">Download JSON key</button>
      </div>`;
      
      document.getElementById('downloadKeyBtnB').addEventListener('click', () => {
        const blob = new Blob([keyJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = (saEmail.replace(/[@\/]/g, '_') + '-key.json'); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showToast('success', 'Key downloaded');
        log('INFO', 'Key downloaded B', { saEmail });
      });
      setStatus('Success — key generated.');
      showToast('success', 'Key generated');
      log('INFO', 'Flow B completed', { saEmail });
    } catch (err) {
      const em = extractErrorMessage(err);
      log('ERROR', 'Flow B failed', { err: em });
      const code = genErrorCode();
      const excerpt = getLogExcerpt(50);
      resultArea.style.display = 'block';
      resultArea.innerHTML = `<div class="oneLineError p-4 bg-red-900/50 border border-red-500 rounded-lg flex justify-between items-center gap-4">
        <div class="text-red-300">Provisioning failed — ${code}. Copy & email this to support.</div>
        <button class="ghost p-2 rounded-md bg-red-700/50 hover:bg-red-700 text-red-200" id="mailErrB">Contact</button>
      </div>`;
      document.getElementById('mailErrB').addEventListener('click', () => openSupportMail({ errorCode: code, excerpt }));
      setStatus('Provisioning failed — ' + code, true);
      showToast('error', 'Provisioning failed — ' + code, { persistent: true });
    } finally {
      setButtonLoading(btn, false);
    }
  }

  function openSupportMail(opts = {}) {
    const to = encodeURIComponent('support@dise.com');
    const subj = encodeURIComponent('SignageOS provisioning - support request');
    let body = `Hello,%0A%0AWe attempted provisioning with DISE provisioning tool.%0A%0A`;
    if (opts.errorCode) {
      body += `Error code: ${opts.errorCode}%0A%0A`;
      body += `Log excerpt (last lines):%0A${encodeURIComponent(opts.excerpt || getLogExcerpt(40))}%0A%0A`;
      body += `Please advise.%0A%0A`;
    }
    const mailto = `mailto:${to}?subject=${subj}&body=${body}`;
    window.location.href = mailto;
    showToast('info', 'Opened mail client');
  }

  /* ———————
     Event bindings
     ——————— */
  document.querySelectorAll('.runBtn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const action = e.currentTarget.dataset.action;
      const clientId = document.getElementById('clientId').value.trim();

      if (!clientId || !/\d+-[a-z0-9]+\.apps\.googleusercontent\.com$/.test(clientId)) {
        setStatus('Please paste a valid OAuth Client ID (ends with .apps.googleusercontent.com)', true);
        showToast('error', 'Invalid OAuth Client ID');
        return;
      }
      resultArea.style.display = 'none'; resultArea.innerHTML = '';
      
      if (action === 'runA') {
        log('INFO', 'User started flow A', { clientId });
        await runFlowA({ clientId }, btn);
      } else if (action === 'runB') {
        const saEmail = document.getElementById('saEmailInput').value.trim();
        if (!saEmail) {
          showToast('error', 'Please enter a Service Account email');
          return;
        }
        log('INFO', 'User started flow B', { clientId, saEmail });
        await runFlowB({ clientId, saEmail }, btn);
      }
    });
  });

  /* Log/Clear buttons */
  document.getElementById('downloadLogBtn').addEventListener('click', () => { downloadLogFile(); showToast('info', 'Log downloaded'); });
  document.getElementById('clearBtn').addEventListener('click', () => {
    try { localStorage.removeItem('dise_audit_log'); } catch (e) {}
    logEntries.length = 0;
    resultArea.style.display = 'none'; resultArea.innerHTML = '';
    setStatus('Ready');
    showToast('info', 'Cleared');
  });

  /* Onboarding script */
  const scriptText = `#!/bin/bash
#
# DISE Partner Onboarding Script (gcloud CLI)
#
# This script creates a new Service Account and key, and fetches your
# Google Workspace Customer ID for SignageOS provisioning.
#
# -----------------
# --- PREREQUISITES ---
# 1. Google Cloud SDK installed: https://cloud.google.com/sdk/docs/install
# 2. Logged in with gcloud:
#    gcloud auth login
#
# 3. Authenticate with necessary scopes:
#    gcloud auth application-default login --scopes="https://www.googleapis.com/auth/admin.directory.customer.readonly","https://www.googleapis.com/auth/iam"
# -----------------

set -e

echo "--- DISE SignageOS Provisioning ---"
echo ""

# 1. Get Project ID
read -p "Enter your Google Cloud Project ID: " PROJECT_ID
if [ -z "$PROJECT_ID" ]; then
    echo "Error: Project ID cannot be empty."
    exit 1
fi
gcloud config set project "$PROJECT_ID"
echo "Set active project to: $PROJECT_ID"
echo ""

# 2. Get Workspace Customer ID
echo "Fetching Google Workspace Customer ID..."
CUSTOMER_ID=$(gcloud admin directory customers get my_customer --format="value(id)")
echo "✅ Customer ID: $CUSTOMER_ID"
echo ""

# 3. Create Service Account
RAND_SUFFIX=$(LC_ALL=C tr -dc 'a-z0-9' < /dev/urandom | head -c 6)
SA_ID="signageos-$RAND_SUFFIX"
SA_EMAIL="$SA_ID@$PROJECT_ID.iam.gserviceaccount.com"
SA_DISPLAY_NAME="SignageOS integration (created via DISE)"

echo "Creating Service Account: $SA_ID"
gcloud iam service-accounts create "$SA_ID" --display-name="$SA_DISPLAY_NAME"
echo "✅ Service Account Email: $SA_EMAIL"
echo ""

# 4. Create Service Account Key
KEY_FILE_PATH="./dise-signageos-key-$SA_ID.json"
echo "Creating JSON key file at: $KEY_FILE_PATH"
gcloud iam service-accounts keys create "$KEY_FILE_PATH" --iam-account="$SA_EMAIL"
echo "✅ Key file created."
echo ""

# 5. Final Output
echo "--- Provisioning Complete ---"
echo "Please provide DISE with these details:"
echo ""
echo "  1. Customer ID: $CUSTOMER_ID"
echo "  2. Service Account Key File: $KEY_FILE_PATH (JSON file)"
echo ""
echo "Keep the .json key file safe and secure."
echo "---------------------------------"
`;

  const scriptCard = document.getElementById('scriptCard');
  const scriptCode = document.getElementById('scriptCode');
  document.getElementById('viewScriptBtn').addEventListener('click', () => {
    scriptCard.classList.remove('hidden');
    scriptCode.textContent = scriptText;
  });
  document.getElementById('closeScript').addEventListener('click', () => { scriptCard.classList.add('hidden'); });
  document.getElementById('copyScriptBtn').addEventListener('click', () => { copyText(scriptText); });

  /* load saved logs */
  try {
    const saved = JSON.parse(localStorage.getItem('dise_audit_log') || '[]');
    if (Array.isArray(saved) && saved.length) {
      saved.forEach(s => logEntries.push(s));
      log('INFO', 'Loaded saved logs', { count: saved.length });
    }
  } catch (e) { log('WARN', 'Failed to load saved logs', { err: e.message }); }

  setStatus('Ready');
  document.getElementById('clientId').focus();
});
</script>
</body>
</html>
